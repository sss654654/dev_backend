<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>ëŒ€ê¸° ì¤‘</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background-color: #f4f7f6; display: grid; place-content: center; min-height: 90vh; }
        .card { border: 1px solid #e0e0e0; border-radius: 16px; padding: 24px 32px; max-width: 480px; background-color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.07); text-align: center; }
        .big { font-size: 48px; font-weight: 800; margin: 4px 0 16px; color: #1a73e8; }
        .muted { color: #5f6368; font-size: 14px; }
        .ok { color: #0b7; font-weight: 700; }
        .err { color: #c33; font-weight: 700; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ccc; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-size: 12px; color: #5f6368; margin-bottom: 4px; }
        .info-value { font-size: 16px; font-weight: 600; color: #202124; }
    </style>
</head>
<body>
<div class="card">
    <div class="muted">ë‚´ ì•ì— ë‚¨ì€ ì¸ì›</div>
    <div id="remaining" class="big">-</div>

    <div class="muted">í˜„ì¬ ìƒíƒœ</div>
    <div id="status" style="font-weight: 600;">ì—°ê²° ì¤‘...</div>

    <div id="done" style="display:none; margin-top:16px;" class="ok">
        ğŸ‰ ì…ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ê°€ ê³§ ì´ë™ë©ë‹ˆë‹¤.
    </div>
    <div id="error" style="display:none; margin-top:16px;" class="err">
        ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤â€¦
    </div>

    <div class="info-grid">
        <div class="info-item">
            <span class="info-label">ë‚˜ì˜ ëŒ€ê¸°ë²ˆí˜¸</span>
            <span id="mySeq" class="info-value">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">í˜„ì¬ í˜¸ì¶œë²ˆí˜¸</span>
            <span id="headSeq" class="info-value">-</span>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const params = new URL(location.href).searchParams;
    const type = params.get('type') || '';
    const id = params.get('id') || '';
    const requestId = params.get('requestId') || '';
    const mySeq = parseInt(params.get('mySeq') || '0', 10);
    const initialHeadSeq = parseInt(params.get('headSeq') || '0', 10);
    const initialMyRank = parseInt(params.get('myRank') || '0', 10);

    let currentHeadSeq = initialHeadSeq;

    const getEl = (id) => document.getElementById(id);
    const setStatus = (text) => { getEl('status').innerText = text; };
    const showError = (visible) => { getEl('error').style.display = visible ? 'block' : 'none'; };

    function updateDisplay() {
        const remaining = Math.max(0, mySeq - currentHeadSeq);
        getEl('remaining').innerText = remaining.toLocaleString();
        getEl('mySeq').innerText = mySeq.toLocaleString();
        getEl('headSeq').innerText = currentHeadSeq.toLocaleString();
    }

    const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws-stomp';
    let client = null;
    let retryCount = 0;

    function connect() {
        if (!type || !id || !requestId || !mySeq) {
            setStatus('í•„ìˆ˜ ì •ë³´(type, id, requestId, mySeq)ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        client = Stomp.over(new WebSocket(wsUrl));
        client.debug = null;
        client.heartbeat.outgoing = 10000;
        client.heartbeat.incoming = 10000;

        client.connect({},
            () => {
                retryCount = 0;
                showError(false);
                setStatus('ëŒ€ê¸° ì¤‘...');

                const dynamicStatsTopic = `/topic/stats/${type}/${id}`;
                client.subscribe(dynamicStatsTopic, (msg) => {
                    // â˜… 1. ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ ì½˜ì†”ì— ê¸°ë¡í•©ë‹ˆë‹¤.
                    console.log(`[STATS MSG] from ${dynamicStatsTopic}:`, msg.body);
                    try {
                        const stats = JSON.parse(msg.body);
                        currentHeadSeq = stats.headSeq;
                        updateDisplay();
                    } catch (e) {
                        console.error('Stats ë©”ì‹œì§€ íŒŒì‹± ì‹¤íŒ¨:', e);
                    }
                });

                const admitTopic = `/topic/admit/${requestId}`;
                client.subscribe(admitTopic, (msg) => {
                    // â˜… 2. ê°œì¸ ì…ì¥ ì•Œë¦¼ ë©”ì‹œì§€ë„ ì½˜ì†”ì— ê¸°ë¡í•©ë‹ˆë‹¤.
                    console.log(`[ADMIT MSG] from ${admitTopic}:`, msg.body);
                    try {
                        const data = JSON.parse(msg.body);
                        if (data.status === 'ADMITTED') {
                            setStatus('ì…ì¥ í—ˆê°€ë¨!');
                            getEl('done').style.display = 'block';

                            // â˜… 3. typeì— ë”°ë¼ ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤.
                            setTimeout(() => {
                                if (data.type === 'movie') {
                                    // ì˜í™” ID(data.id)ë¥¼ í¬í•¨í•˜ì—¬ ì¢Œì„ ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
                                    window.location.href = 'http://localhost:5173/seats';
                                } else if (data.type === 'coupon') {
                                    // ì¿ í° í˜ì´ì§€ë¡œ ì´ë™
                                    window.location.href = 'http://localhost:5173/coupon';
                                } else {
                                    // ì˜ˆì™¸ ì²˜ë¦¬: ê¸°ë³¸ í˜ì´ì§€ë¡œ ì´ë™
                                    window.location.href = '/';
                                }
                            }, 2000); // 2ì´ˆ í›„ ì´ë™
                        }
                    } catch (e) {
                        console.error('Admit ë©”ì‹œì§€ íŒŒì‹± ì‹¤íŒ¨:', e);
                    }
                });
            },
            (err) => {
                console.error('STOMP ì—°ê²° ì‹¤íŒ¨:', err);
                showError(true);
                setStatus('ì›¹ì†Œì¼“ ì¬ì—°ê²° ì¤‘...');
                const delay = Math.min(1500 * Math.pow(1.6, retryCount++), 15000);
                setTimeout(connect, delay);
            }
        );
    }

    window.addEventListener('DOMContentLoaded', () => {
        setStatus(`ì´ˆê¸° ìˆœìœ„: ${initialMyRank.toLocaleString()}ìœ„`);
        updateDisplay();
        connect();
    });

    window.addEventListener('beforeunload', () => {
        try { if (client && client.connected) client.disconnect(); } catch {}
    });
</script>
</body>
</html>
