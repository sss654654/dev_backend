stages: 
  - test
  - build
  - login
  - docker
  - deploy   # ArgoCD를 위한 deploy 단계
  - notify

image: maven:3-eclipse-temurin-17

variables:
  # GitLab CI/CD 변수에서 설정해야 할 값들
  # ECR_NAMESPACE: "732739477448.dkr.ecr.ap-northeast-2.amazonaws.com"
  # ECR_REPO: "dev-gitlab-repo"
  # AWS_DEFAULT_REGION: "ap-northeast-2"
  
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  SLACK_WEBHOOK_URL: "https://hooks.slack.com/services/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"
  PROJECT_NAME: "CGV API"
  VER: "1.0.0"
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA # 이미지 태그는 커밋 해시를 사용

default:
  tags: [cwave]

# 1. Test 단계: 정적 분석 및 취약점 점검
build-sonar:
  stage: test
  cache:
    policy: pull-push
    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
    paths:
      - "${SONAR_USER_HOME}/cache"
      - sonar-scanner/
  script: 
    - mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
  allow_failure: true

owasp_dependency_check:
  stage: test
  image:
    name: registry.gitlab.com/gitlab-ci-utils/docker-dependency-check:latest
    entrypoint: [""]
  script:
    - /usr/share/dependency-check/bin/dependency-check.sh --scan "./" --format ALL --project "$CI_PROJECT_NAME" --failOnCVSS 0
  allow_failure: true
  artifacts:
    when: always
    paths:
      - "./dependency-check-report.html"
      - "./dependency-check-report.json"

# 2. Build 단계: Maven으로 JAR 파일 빌드
build:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  cache:
    paths: 
      - .m2/repository
  script:
    - mvn -B -DskipTests clean package
  artifacts:
    paths: 
      - target/*.jar
    expire_in: 1 hour

# 3. Login 단계: ECR 로그인 토큰 생성
ecr-login:
  stage: login
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  script:
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION > ecr_token.txt
  artifacts:
    paths:
      - ecr_token.txt
      - target/*.jar
    expire_in: 1 hour

# 4. Docker 단계: Docker 이미지 빌드 및 ECR 푸시
docker-build-separate:
  stage: docker
  image: docker:24.0.5
  services: 
    - docker:24.0.5-dind
  needs:
    - job: build
      artifacts: true
    - job: ecr-login
      artifacts: true
  dependencies:
    - ecr-login
  script:
    - cat ecr_token.txt | docker login --username AWS --password-stdin $ECR_NAMESPACE
    - echo "Image name = $ECR_NAMESPACE/$ECR_REPO:$VER-$IMAGE_TAG"
    - docker build -t "$ECR_NAMESPACE/$ECR_REPO:$VER-$IMAGE_TAG" -t "$ECR_NAMESPACE/$ECR_REPO:latest" .
    - docker push "$ECR_NAMESPACE/$ECR_REPO:$VER-$IMAGE_TAG"
    - docker push "$ECR_NAMESPACE/$ECR_REPO:latest"

# 5. Deploy 단계: Helm Chart 이미지 태그 업데이트 (ArgoCD 트리거)
update-helm-chart:
  stage: deploy
  image:
    name: alpine/helm:3.9.0
    entrypoint: [""]
  script:
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git checkout $CI_COMMIT_BRANCH
    - sed -i "s/tag: .*/tag: \"$VER-$IMAGE_TAG\"/" helm/values-dev.yaml
    - git add helm/values-dev.yaml
    - git commit -m "ci: Update image tag to $VER-$IMAGE_TAG [skip ci]"
    - git push origin $CI_COMMIT_BRANCH
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# 6. Notify 단계: 파이프라인 결과 Slack 알림
notify-success:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\": \"✅ GitLab CI completed for $CI_PROJECT_NAME ($CI_COMMIT_REF_NAME)\"}" \
      $SLACK_WEBHOOK_URL
  rules:
    - when: on_success

notify-failure:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\": \"❌ GitLab CI failed for $CI_PROJECT_NAME ($CI_COMMIT_REF_NAME)\"}" \
      $SLACK_WEBHOOK_URL
  rules:
    - when: on_failure