stages:
  - test
  - build
  - login
  - docker
  - deploy
  - notify

image: maven:3-eclipse-temurin-17

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  SLACK_WEBHOOK_URL: "https://hooks.slack.com/services/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"
  PROJECT_NAME: "CGV API"
  VER: "1.0.0"

default:
  tags: 
    - cwave

# â˜…â˜…â˜… SonarQube ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ â˜…â˜…â˜…
build-sonar:
  stage: test
  cache:
    policy: pull-push
    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
    paths:
      - "${SONAR_USER_HOME}/cache"
      - sonar-scanner/
  script:
    - mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
  allow_failure: true


owasp_dependency_check:
  image:
    name: registry.gitlab.com/gitlab-ci-utils/docker-dependency-check:latest
    entrypoint: [""]
  stage: test
  script:
    - >
      /usr/share/dependency-check/bin/dependency-check.sh --scan "./" --format ALL
      --project "$CI_PROJECT_NAME" --failOnCVSS 0
  allow_failure: true
  artifacts:
    when: always
    paths:
      - "./dependency-check-report.html"
      - "./dependency-check-report.json"

build:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  cache:
    paths:
      - .m2/repository
  script:
    - mvn -B -DskipTests clean package
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 hour

ecr-login:
  stage: login
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  script:
    - echo "=== Getting ECR Login Token ==="
    - aws ecr get-login-password --region $PROD_REGION > ecr_token.txt
  artifacts:
    paths:
      - ecr_token.txt
    expire_in: 1 hour

docker-build-separate:
  stage: docker
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  needs:
    - job: build
      artifacts: true
    - job: ecr-login
      artifacts: true
  dependencies:
    - build
    - ecr-login
  script:
    - echo "=== Docker Login ==="
    - cat ecr_token.txt | docker login --username AWS --password-stdin $ECR_NAMESPACE
    - echo "Login successful"
    - echo "=== Building and Pushing Image ==="
    - export TAG=$(date +%y%m%d-%H%M%S)
    - echo "$VER-$TAG" > tag.txt
    - |
      # ë¸Œëœì¹˜ë³„ ë‹¤ë¥¸ ECR ë¦¬í¬ì§€í† ë¦¬ ì‚¬ìš©
      if [ "$CI_COMMIT_BRANCH" = "production" ]; then
        REPO_NAME="prod-cgv-api"
      else
        REPO_NAME="dev-gitlab-repo"
      fi
      echo "Using repository: $REPO_NAME"
    - docker build -t "$ECR_NAMESPACE/$REPO_NAME:$VER-$TAG" -t "$ECR_NAMESPACE/$REPO_NAME:latest" .
    - docker push "$ECR_NAMESPACE/$REPO_NAME:$VER-$TAG"
    - docker push "$ECR_NAMESPACE/$REPO_NAME:latest"
    - echo "=== Complete ==="
  artifacts:
    paths:
      - tag.txt

# # â˜…â˜…â˜… Dev í™˜ê²½ ë°°í¬ (main ë¸Œëœì¹˜) â˜…â˜…â˜…
# deploy-to-dev:
#   stage: deploy
#   image:
#     name: alpine/k8s:1.28.2
#   needs:
#     - job: docker-build-separate
#       artifacts: true
#   script:
#     - |
#       echo "=== Deploying to Development Environment ==="
#       cd ..
#       pwd && ls -la
#       git config --global user.email "gitlab-ci@example.com"
#       git config --global user.name "subin"
#       export NEW_TAG=$(cat $CI_PROJECT_DIR/tag.txt)
#       echo "Applying new tag to dev: $NEW_TAG"
      
#       # Dev í™˜ê²½ì—ì„œëŠ” values-dev.yaml íŒŒì¼ì„ ì—…ë°ì´íŠ¸
#       sed -i "s/tag: \".*\"/tag: \"$NEW_TAG\"/" values-dev.yaml
      
#       git add values-dev.yaml
#       git commit -m "ğŸ”§ ci: Update dev image tag to $NEW_TAG"
#       git push "https://oauth2:${GIT_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git" HEAD:$CI_COMMIT_BRANCH
      
#       echo "âœ… Development deployment completed"
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "main"'

# # â˜…â˜…â˜… Production í™˜ê²½ ë°°í¬ (production ë¸Œëœì¹˜) â˜…â˜…â˜…
# deploy-to-production:
#   stage: deploy
#   image:
#     name: alpine/k8s:1.28.2
#   needs:
#     - job: docker-build-separate
#       artifacts: true
#   script:
#     - |
#       echo "=== Deploying to Production Environment ==="
#       cd ..
#       pwd && ls -la
#       git config --global user.email "gitlab-ci@example.com"
#       git config --global user.name "subin"
#       export NEW_TAG=$(cat $CI_PROJECT_DIR/tag.txt)
#       echo "Applying new tag to production: $NEW_TAG"
      
#       # Production í™˜ê²½ì—ì„œëŠ” values-prod.yaml íŒŒì¼ì„ ì—…ë°ì´íŠ¸
#       sed -i "s/tag: \".*\"/tag: \"$NEW_TAG\"/" values-prod.yaml
      
#       git add values-prod.yaml
#       git commit -m "ğŸš€ ci: Update production image tag to $NEW_TAG"
#       git push "https://oauth2:${GIT_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git" HEAD:$CI_COMMIT_BRANCH
      
#       echo "âœ… Production deployment completed"
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "production"'

notify-success:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "production" ]; then
        ENVIRONMENT="ğŸš€ PRODUCTION"
        EMOJI="ğŸ‰"
      else
        ENVIRONMENT="ğŸ”§ DEVELOPMENT"
        EMOJI="âœ…"
      fi
      
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\": \"$EMOJI GitLab CI completed for $PROJECT_NAME ($ENVIRONMENT - $CI_COMMIT_REF_NAME)\"}" \
      $SLACK_WEBHOOK_URL
  rules:
    - when: on_success

notify-failure:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "production" ]; then
        ENVIRONMENT="ğŸš€ PRODUCTION"
        EMOJI="ğŸ’¥"
      else
        ENVIRONMENT="ğŸ”§ DEVELOPMENT"
        EMOJI="âŒ"
      fi
      
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\": \"$EMOJI GitLab CI failed for $PROJECT_NAME ($ENVIRONMENT - $CI_COMMIT_REF_NAME)\"}" \
      $SLACK_WEBHOOK_URL
  rules:
    - when: on_failure