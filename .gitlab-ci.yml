stages:
  - test
  - build
  - login
  - docker
  - deploy
  - notify

image: maven:3-eclipse-temurin-17

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  SLACK_WEBHOOK_URL: "https://hooks.slack.com/services/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"
  PROJECT_NAME: "CGV API"
  VER: "1.0.0"

default:
  tags: 
    - cwave

# ‚òÖ‚òÖ‚òÖ SonarQube ÏΩîÎìú ÌíàÏßà Í≤ÄÏÇ¨ ‚òÖ‚òÖ‚òÖ. .
build-sonar:
  stage: test
  cache:
    policy: pull-push
    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
    paths:
      - "${SONAR_USER_HOME}/cache"
      - sonar-scanner/
  script:
    - mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN
  allow_failure: true


# owasp_dependency_check:
#   image:
#     name: registry.gitlab.com/gitlab-ci-utils/docker-dependency-check:latest
#     entrypoint: [""]
#   stage: test
#   script:
#     - >
#       /usr/share/dependency-check/bin/dependency-check.sh --scan "./" --format ALL
#       --project "$CI_PROJECT_NAME" --failOnCVSS 0
#   allow_failure: true
#   artifacts:
#     when: always
#     paths:
#       - "./dependency-check-report.html"
#       - "./dependency-check-report.json"

build:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  cache:
    paths:
      - .m2/repository
  script:
    - mvn -B -DskipTests clean package
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 hour

ecr-login:
  stage: login
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  script:
    - echo "=== Getting ECR Login Token ==="
    - aws ecr get-login-password --region $PROD_REGION > ecr_token.txt
  artifacts:
    paths:
      - ecr_token.txt
    expire_in: 1 hour

docker-build-separate:
  stage: docker
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  needs:
    - job: build
      artifacts: true
    - job: ecr-login
      artifacts: true
  dependencies:
    - build
    - ecr-login
  script:
    - echo "=== Docker Login ==="
    - cat ecr_token.txt | docker login --username AWS --password-stdin $ECR_NAMESPACE
    - echo "Login successful"
    - echo "=== Building and Pushing Image ==="
    - export TAG=$(date +%y%m%d-%H%M%S)
    - echo "$VER-$TAG" > tag.txt
    - |
      # Î∏åÎûúÏπòÎ≥Ñ Îã§Î•∏ ECR Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ ÏÇ¨Ïö©
      if [ "$CI_COMMIT_BRANCH" = "production" ]; then
        REPO_NAME="prod-cgv-api"
      else
        REPO_NAME="dev-gitlab-repo"
      fi
      echo "Using repository: $REPO_NAME"
    - docker build -t "$ECR_NAMESPACE/$REPO_NAME:$VER-$TAG" -t "$ECR_NAMESPACE/$REPO_NAME:latest" .
    - docker push "$ECR_NAMESPACE/$REPO_NAME:$VER-$TAG"
    - docker push "$ECR_NAMESPACE/$REPO_NAME:latest"
    - echo "=== Complete ==="
  artifacts:
    paths:
      - tag.txt

notify-success:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "production" ]; then
        ENVIRONMENT="üöÄ PRODUCTION"
        EMOJI="üéâ"
      else
        ENVIRONMENT="üîß DEVELOPMENT"
        EMOJI="‚úÖ"
      fi
      
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\": \"$EMOJI GitLab CI completed for $PROJECT_NAME ($ENVIRONMENT - $CI_COMMIT_REF_NAME)\"}" \
      $SLACK_WEBHOOK_URL
  rules:
    - when: on_success

notify-failure:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "production" ]; then
        ENVIRONMENT="üöÄ PRODUCTION"
        EMOJI="üí•"
      else
        ENVIRONMENT="üîß DEVELOPMENT"
        EMOJI="‚ùå"
      fi
      
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\": \"$EMOJI GitLab CI failed for $PROJECT_NAME ($ENVIRONMENT - $CI_COMMIT_REF_NAME)\"}" \
      $SLACK_WEBHOOK_URL
  rules:
    - when: on_failure